use v5.18;
#use strict;
#use warnings;
use Config::Tiny;
use Mojo::UserAgent;
use Mojo::DOM;
use Carp;
use Time::HiRes 'usleep';
use DBI;
use Date::Manip;
use Date::Manip::Date;
use List::Util qw<shuffle>;
use List::Util qw(max);
use File::Basename qw<dirname>;
use Digest::MD5 qw(md5_hex);
use Time::HiRes qw(gettimeofday);

binmode STDOUT, ':utf8';

my $ua = Mojo::UserAgent->new;
my $cache_d = 'cache/';
$| = 1;

# Site Configuration
#     http://domain.yuku.com/viewtopic.php?t=11571&start=0
my $config = Config::Tiny->read('secrets.ini');
my $domain = $config->{_}->{domain};

my $api_path       = 'viewtopic.php';
# This is the path of where the database file will be created
# (If you use a relative path, you should keep running it from the same working directory)
my $db_file        = "Forum.db";
# Select the topics you wish to grab.  The topic ids are part of the URL, like
#     http://domain.yuku.com/hey-guise!-t152-s60.html
# This is topic id 152, starting at post #61
my $start_topic    = 0;
my $end_topic      = 9100;
my $posts_per_page = 20;
# Or override this by asking for a list of specific thread numbers 

#8768,3831
my @get_topics     = (8768,3831,1417,323,347,1949,662,652,970,1242,334,1492,353,1614,286,528,1841,596,1827,198,1022,1602,516,131,828,1478,10,850,643,1599,1426,783,955,1424,1107,1083,1340,1810,1859,969,1045,924,333,939,614,1327,1722,200,1536,885,1433,1334,1664,1029,1639,1932,1797,326,363,1088,1714,1289,1737,919,1925,1130,1723,687,1039,1802,78,1725,1124,722,1299,1690,1541,370,711,1005,250,751,530,9,301,1042,1822,174,556,1348,807,278,831,1772,1796,1057,256,293,298,1726,1692,1481,777,28,568,1074,1762,1358,21,237,219,1423,175,1453,1204,459,1250,343,7,1127,415,85,725,611,1744,1598,1392,186,708,913,1589,112,1077,782,1688,1803,266,11,209,1030,1716,1381,1773,1041,120,628,1151,1727,1399,46,1820,1256,426,1531,1324,1697,716,1763,164,925,1412,737,229,518,1825,789,1125,1143,769,63,223,1735,91,1765,1413,328,1691,956,1342,310,1843,55,1529,1146,150,109,1570,976,665,819,220,18,1222,603,101,514,1758,507,780,971,633,365,750,90,70,907,1782,417,978,1979,1202,1187,315,451,661,288,1683,491,299,853,1479,1739,1432,1120,257,798,963,362,749,400,864,816,863,1065,1545,1043,500,1586,337,1745,1705,1656,1597,1948,1456,367,1645,1805,410,304,922,583,577,658,290,586,705,1170,1134,594,498,1108,1411,1337,647,1984,941,340,843,1783,670,1254,1370,1669,927,1954,1791,113,838,1428,1403,1696,1677,527,291,1963,621,42,1178,1819,1476,1145,481,409,884,1192,1740,1103,110,375,1544,727,1455,535,27,1652,1437,248,1996,615,158,1310,709,1924,350,463,1747,295,373,1279,701,1786,1862,554,578,397,273,6,1013,402,268,809,1736,1721,683,856,935,1561,1592,1154,462,1459,1811,1201,185,1990,600,1667,1277,95,208,1060,72,48,797,1297,1858,1717,686,1682,981,753,371,1129,666,1274,1033,1928,1713,1071,453,1665,1964,1623,985,810,341,1484,1640,1339,287,1121,165,1719,1986,1280,351,721,1318,674,1752,1678,539,533,1733,1532,111,723,1152,636,205,490,1781,170,354,1790,470,812,1852,986,1394,14,1870,1768,1454,1807,519,33,572,730,506,1916,1345,269,672,142,62,1162,1845,619,779,39,1119,1512,224,430,240,183,202,1534,699,894,1702,1663,1037,1003,446,1153,878,302,1953,764,1885,1547,1641,940,388,1568,891,1704,541,537,1578,1966,681,399,1418,480,389,233,942,998,1330,1425,1977,1526,428,902,1985,973,1808,1093,613,1812,775,1058,25,549,102,990,1987,901,61,1943,796,923,1380,34,731,322,1681,1366,1832,680,145,886,217,1085,359,161,1368,1283,1983,960,1325,679,697,325,1331,1907,1488,1023,1196,466,1282,1874,232,1036,437,914,876,1908,336,479,1787,1894,739,591,475,349,1884,1025,1543,284,818,1406,52,768,1563,1800,1560,630,422,1571,839,387,1444,772,169,484,228,383,1893,835,706,1094,848,184,1275,1391,852,1430,221,496,1590,1565,962,1540,262,199,204,225,1594,41,1849,1498,1853,992,305,384,215,1693,515,667,1857,861,1311,1775,1435,1794,1537,903,405,1158,1076,1836,623,557,1438,508,762,1303,1856,1575,94,465,1184,407,1261,1582,1801,1336,308,119,125,1519,1312,187,1021,1724,657,820,735,743,1687,1441,1779,423,512,774,1632,778,1221,1419,928,141,171,172,1356,832,231,1398,213,855,1844,1359,1701,1759,444,1815,598,1172,904,1167,1625,1434,1326,241,88,1001,1601,1321,993,851,1611,785,86,133,146,87,243,368,513,717,1514,1215,1684,1469,1581,1521,1731,1670,1062,1698,1055,1606,1231,883,450,1789,155,604,1777,1137,1950,787,1243,391,759,814,758,1821,121,646,1700,984,1291,1285,1332,1133,188,808,1515,1989,1390,1096,918,1577,1024,1097,1159,805,1363,1709,5,247,12,566,1855,1865,1936,319,1195,1230,1214,692,1404,1165,1427,1708,1239,54,1199,1408,627,555,108,1659,1557,847,358,1839,651,1756,398,1393,648,1738,505,148,1089,309,1147,1662,888,1223,1551,1574,226,726,948,126,589,210,1940,1395,1508,1530,1040,952,1114,1377,1251,263,579,997,1470,40,791,1748,1804,1113,1978,1585,1485,1100,1749,1774,734,802,1828,1132,1980,526,1465,724,822,899,950,1183,1072,1106,1350,1743,1449,179,1046,1259,1053,318,660,1746,1510,1600,1173,1905,1974,425,1017,892,954,543,1293,1992,332,1182,128,920,910,1816,645,1650,73,482,135,898,489,1451,395,203,1176,1082,729,51,1292,1166,1960,1754,811,477,1474,3,1630,251,1015,1878,1798,868,842,983,840,1450,1604,1091,242,1068,366,754,829,53,1171,22,755,2,1028,1619,173,1075,1480,1496,1622,867,356,1648,414,1002,977,1945,464,320,1753,1471,151,192,1520,1493,252,1516,1431,1518,1850,189,1991,1846,1517,136,345,433,279,1967,24,1268,43,776,292,32,833,1269,1799,1567,26,69,394,1649,511,1549,1554,1260,93,177,1440,1941,1814,1981,713,930,238,1771,1304,830,342,1186,1553,1235,763,89,1879,1375,1888,756,1689,1237,1475,1626,259,1177,77,316,989,1612,379,1123,1961,1706,1287,1788,357,859,642,1751,1179,1876,880,503,324,1955,625,1556,1646,1507,485,540,138,1741,1919,1712,1558,1383,1416,536,1603,144,1128,1314,411,1405,1338,790,1105,638,1494,166,1926,1142,118,190,1341,130,1333,562,879,103,1503,618,331,1354,896,1573,1273,83,206,1609,1194,348,710,550,15,57,1818,893,587,771,1923,937,1232,1188,306,1369,71,649,163,239,1566,1676,1087,1851,1593,20,13,346,900,1729,1483,974,1631,1584,74,567,1742,471,38,1329,703,1323,1080,1555,1624,854,132,694,1034,282,1971,1628,1780,1760,656,654,1136,84,1197,1397,1320,932,16,1660,889,75,1319,1298,520,1410,1569,532,565,1629,1588,871,887,501,1238,1313,1168,1098,659,1513,689,1501,815,468,1290,1272,1621,1421,114,1608,1353,1149,1583,431,911,1548,1929,742,1580,1539,784,49,946,1766,936,629,143,1764,376,134,1264,1315,584,639,1595,620,139,551,8,943,895,1044,1817,1785,803,1081,499,909,1792,693,788,1972,905,590,1328,68,1550,1533,806,612,153,1189,45,181,588,478,460,289,65,168,846,760,653,685,1234,1422,617,1734,303,261,236,1770,1920,1357,403,875,294,1263,1205,1703,1610,454,1295,1615,1651,1509,117,37,728,1436,650,521,59,945,1882,1462,1110,29,1829,524,1892,655,1316,327,1004,156,372,115,344,1248,1627,996,890,1477,123,1559,441,369,1657,1227,1135,1084,1031,1460,1854,1675,695,1806,1647,958,1861,1122,487,1012,191,1244,1680,988,35,569,793,197,1347,1866,1613,1139,1335,1877,1407,1464,1813,1463,1482,31,1988,1010,429,1873,1138,559,738,795,1564,1707,972,817,253,1247,1203,1367,339,1633,1360,1527,744,912,1095,534,1000,873,917,1638,127,1831,277,1834,1522,1826,841,510,1161,1750,408,392,176,1686,1011,234,1216,1148,1637,483,380,821,1562,81,1975,1009,330,1538,1579,1252,881,599,1495,154,92,1525,921,1374,147,1157,1069,580,56,1190,1643,757,1472,1070,76,1306,1056,576,360,1276,538,214,1572,1281,823,1490,1776,1185,845,509,1528,1635,1409,276,1226,1373,1207,105,386,1020,517,211,570,1793,194,677,1014,258,1944,361,1542,107,1220,1191,1617,1835,1090,1051,1732,931,1840,218,733,1126,1066,267,857,1546,1951,668,1228,546,106,626,866,1837,1911,1112,1349,1116,1939,396,553,1757,1118,1618,897,1308,275,461,255,1497,274,529,1587,608,1728,1871,874,1505,60,585,1035,995,1605,1442,745,624,767,1224,966,669,761,413,1229,804,592,178,44,949,1500,1552,593,1270,434,1054,834,1591,877,792,870,1666,445,1830,994,1400,1997,159,1296,1213,1761,547,1511,230,1654,1063,1364,1102,432,1998,700,1241,644,116,1246,1164,1956,631,488,548,933,195,640,1915,416,1769,1386,1995,1443,688,1115,497,1596,436,67,1642,1361,801,1073,1402,98,80,1144,844,196,991,364,1150,1795,96,1965,447,1993,1699,79,1658,1784,317,1523,1655,249,1052,129,766,272,321,862,605,1668,167,1016,1720,1245,424,858,1198,1302,30,1959,1504,872,378,957,2000,4000,8006,4187,3781,4958,5072,5611,3238,7898,7637,7925,2900,5575,7521,4357,3271,3255,2202,8351,3551,3616,8702,2050,5183,7007,4219,2624,3922,4680,6322,5235,8117,6894,4712,6292,5654,8924,4896,3084,3989,7497,4075,4861,2561,3329,8315,7875,4870,6626,2942,2068,7661,2595,7917,4125,7900,7523,8375,6334,2255,2733,8336,5038,4622,3190,2819,3061,4562,2710,3835,4903,3401,6070,4097,5634,5953,5731,7480,3894,6985,8739,2245,6200,3247,8149,5834,3388,6112,2292,8838,7775,7099,4751,2064,2135,4493,8912,3937,2384,2828,2161,6819,3757,3961,6257,5445,3932,4766,3805,3422,2798,8333,6965,2977,3424,6263,3380,3818,5673,2336,8446,3227,6178,8622,5322,6466,2929,3882,8645,3215,5470,4876,2572,8635,4565,8040,5947,8121,7317,7203,4865,3448,2494,5335,4285,8594,7633,4949,8831,7492,4051,3397,7383,2229,4429,2655,2166,6147,3774,3492,8556,6579,8249,7339,6105,6922,4581,5310,5896,8212,3106,8672,4859,2865,4686,2907,2134,4005,8415,7498,8682,4246,8758,4828,2284,7010,7642,8735,3144,2867,8662,4241,8420,2917,6852,4253,2766,8235,3876,4159,5097,3087,8438,5559,5507,6591,7932,3571,2638,8686,3795,3886,4003,4230,7401,5272,4103,5574,2753,2615,5028,5688,4643,7895,3416,4152,8112,2148,5527,5686,7749,8756,4252,3649,8530,3840,8232,2088,7931,4792,7273,4217,3537,4135,8027,3446,7172,5067,8426,7513,8191,6019,5983,6101,5710,2253,7095,2531,7830,5872,8753,8911,5516,5771,7196,5667,3319,7711,5775,6092,4042,6250,3369,5418,2059,6351,6073,4242,8278,7689,4543,5362,8395,8528,6508,4330,3808,8437,3371,5021,3077,3659,6004,3316,5633,4069,3712,6973,3281,2720,3692,8033,3891,2446,3315,6187,4636,5736,4719,7322,8410,3120,3434,2580,2633,2207,5808,7950,8051,7370,2328,5434,4862,3436,2587,2378,2976,5600,7719,2965,5149,6435,2957,2672,4200,8861,7348,8915,8483,4176,8904,2700,6208,6284,3885,7969,5114,5719,5432,8850,6898,8892,5377,7143,4832,6554,3914,4128,4484,4530,3143,4517,8466,4791,5293,7012,8688,6680,5296,2667,3647,5799,3783,8119,4398,7611,7588,6096,2211,8339,7564,8669,4303,4945,2852,5115,4669,7053,2099,6076,3596,3710,2444,7218,4212,7927,6352,6243,3116,8741,4731,3334,3233,6060,7780,4373,8502,5652,2119,5428,2380,8541,3964,7936,4226,7230,3140,5505,5729,2032,3035,6335,8923,7587,3056,4298,4829,3565,3888,6627,7467,2644,2871,5689,4761,8367,7781,2909,2832,6164,5244,3506,4642,7774,8496,2299,7529,5540,4485,4296,4313,2810,6142,2718,5954,7878,3258,4687,7861,4063,2221,3784,7232,2545,7309,7532,4013,5137,5746,8030,2602,2488,8879,3913,5936,8814,4985,5901,5068,2489,7186,3214,5186,8004,3887,3092,8499,2532,7214,3644,8751,8611,5081,3100,8432,5712,3670,5313,2215,2610,8562,8875,5508,7559,5869,5640,7951,4979,4614,6945,7441,2065,5687,6461,7308,8533,7030,3598,3137,5437,5998,3643,4994,3474,4124,7484,6097,6986,6102,3478,4267,7832,7939,4420,7037,7528,2935,8883,4428,7398,4762,3088,7315,6100,4157,4875,3883,5641,2349,3576,5223,7591,2556,5931,4084,7314,5496,8565,6362,5774,2106,2663,8607,3075,6086,5734,3534,3301,3476,5113,3567,5112,8442,7763,6877,8922,2876,7449,7846,5031,3744,2225,8877,7448,7154,3467,3442,7890,6826,8671,5576,4816,3188,4245,2230,3941,2110,4566,8821,8450,6192,2896,4058,7641,3508,3815,7510,7833,5475,7727,7563,7298,7906,7860,2652,4929,7142,8725,4978,5915,8782,6222,4326,6211,7161,2193,2497,3950,8291,5715,8595,4620,2133,4287,3954,3417,5512,6302,8719,2657,6061,2339,8264,7221,5824,7831,2898,5287,3135,4213,8144,6483,5956,4560,2592,7199,4886,6442,3740,8752,7008,6596,3957,7783,6259,8824,2402,6268,5347,8371,7910,7556,7868,2558,5339,6030,6505,5519,7180,3856,2807,3853,8527,2971,3972,5646,5446,6033,2210,4349,5567,8842,4133,3402,5760,7512,4338,7135,3151,6315,6604,4836,4589,6825,2122,3797,4649,4683,5662,6465,3089,4203,2465,4487,5958,8713,8625,7634,8221,8071,3982,5088,3830,2196,6984,3507,5224,4724,6403,4754,6183,3147,7954,3761,5228,4139,3162,7760,4990,4081,3318,2354,5796,8228,6258,8417,8269,8368,8152,7663,6814,8464,8445,4482,5485,3152,2769,4648,4037,8792,6891,7534,8091,5569,4244,7788,5949,6290,6312,4504,4852,8475,2833,5391,7509,5525,5684,2426,2462,7304,4556,7342,4989,2126,7430,8489,8334,2771,7362,7963,6612,6547,4104,5141,8721,3217,6432,2864,5494,4119,8067,6339,3918,3518,6091,5714,5250,3013,3546,5209,3780,3222,5727,6719,2280,5723,7211,8422,2647,3931,6198,2880,7853,2839,8305,8765,8026,2434,5419,5178,7333,8700,5285,7226,4913,6832,2458,8175,3705,3158,5898,8188,5230,5492,6447,8649,6411,5704,4552,3430,4796,2326,6216,4019,2429,6321,2511,6160,4736,5351,5480,5793,8012,4028,5194,8566,2954,3086,5398,8654,6047,2640,6836,2310,7768,5816,3552,4955,2303,3689,5301,4545,5000,4585,8610,5065,4210,8029,8132,5984,7043,6457,6206,4368,2812,5399,3836,3646,4501,5479,8229,5491,7176,5820,7706,8078,5665,5161,7077,3145,4917,4015,2236,4489,8569,3128,7036,7302,7703,2315,7716,6755,6493,8222,2972,6311,8158,3828,7514,8122,4603,4814,7551,5306,5482,3768,3741,3300,2686,3022,4845,6828,2969,4463,4288,8344,2962,5564,7224,6408,2893,4890,5025,5514,3690,5003,4154,2387,7626,6305,2932,3593,5089,8073,8477,7179,7252,5331,8581,6245,4264,4446,4222,3947,8361,2964,2981,3776,2390,8452,7337,4077,4390,4269,4270,6111,5294,7428,4660,4880,5783,8685,8433,8070,5794,4336,2665,6969,8407,5122,7842,5035,4831,8337,8465,7459,8013,8795,5842,6265,8897,8818,5251,2435,8603,4947,4520,3729,7747,7545,4079,5552,4537,6039,4465,2516,3349,2823,5969,7554,4698,7795,4899,5291,7990,3423,4910,7126,5543,6048,4036,7567,5253,4936,3011,4464,5534,2295,4892,2023,2418,2697,5920,4538,6139,2266,7811,7270,4849,8538,6269,7044,8390,3197,2645,2535,3764,8526,2237,6475,4613,4050,3946,4888,7444,6610,7839,2552,2620,2555,2617,6003,8729,4064,2124,4912,2096,7993,8169,4809,2109,8504,5350,7422,3431,4020,8294,5547,7772,8692,4068,2343,3602,2526,5206,5320,5843,3342,8011,2293,5666,7257,6890,3205,4522,8660,2312,4616,3517,5642,2804,4924,3890,3564,2079,2318,3579,5041,7636,7085,5881,7388,8939,2845,6462,3985,5079,7456,2053,4684,7737,8582,2568,6618,7652,3017,5922,4716,3892,6433,2908,3917,6327,2190,8678,5210,4848,4123,3078,2404,3437,4430,4656,6453,2566,7206,2320,8736,8724,5852,5214,2903,5110,5873,4207,8613,8017,5318,5126,2089,7488,8100,5176,5323,3943,3706,2327,8184,2372,2169,4743,7866,8628,4382,6118,6163,8408,7552,8401,4112,4018,5269,4148,4439,2762,7105,5577,5681,5598,8674,8456,2738,6170,7299,6289,7590,3132,3560,7919,3368,3842,2767,2994,5784,2084,5533,3997,5130,4450,3372,8046,4341,2737,5388,2997,3082,5770,8260,7083,8760,7397,4380,8524,4426,2108,4682,8104,2200,5212,7876,6674,2373,3855,3163,6451,4944,6419,8292,6494,7697,3039,7113,4617,6093,2057,2618,3722,3207,2930,8258,2785,4423,5373,6043,5928,3758,6151,6625,8494,8591,7125,6839,3479,7779,7594,4442,2076,7599,5280,2821,2406,3127,4309,3354,7069,7177,7959,3428,4717,4295,3889,4293,8310,4332,2307,3695,8279,7687,5952,7970,3235,5650,8648,8140,8137,5042,8794,8204,7921,3779,3494,5740,4623,8441,4025,8881,5895,6386,3218,7220,8325,5471,3753,2878,2591,6185,2294,7536,7692,8675,5426,8584,2367,8297,8863,7022,8498,6119,8365,4161,3714,5792,3223,5173,8057,4952,2467,8830,4675,4283,4720,4391,8545,2329,5773,3029,6853,5762,7938,3928,5457,3498,3141,4779,6140,2036,5262,7929,5498,8252,5246,4856,3829,3685,5404,3053,5643,3433,2155,5578,2855,4407,2179,8019,3535,3767,3148,4361,7543,4078,4843,7629,8143,2250,6479,7079,8732,3671,8309,4339,7863,3900,2788,8177,8109,7081,7541,7666,6201,5086,8820,8563,4703,3246,5585,5593,4416,5744,7168,5131,6106,7926,3816,8134,2278,2598,6249,4738,7225,8300,3976,3760,2052,7508,5405,6214,2164,3563,8082,2622,4877,7026,8449,8788,7157,7496,8640,5233,7755,6379,8349,6238,7728,6234,2014,2726,7120,5133,5056,2682,2248,5083,8199,7057,2072,7101,6226,7469,4160,2619,2889,6749,3897,6471,8744,7530,8120,8251,7745,2368,7320,4728,8947,3067,8460,7790,4199,8887,3992,2711,7710,2040,8076,8286,3724,6219,2512,5539,8201,7193,4506,7924,5835,8237,5368,2797,2259,5107,4742,8348,5315,5658,4576,2420,3047,3199,7332,8832,3186,4101,3573,8418,5700,4935,5208,5649,4209,5660,3040,5375,3696,7103,6436,4201,3575,5195,2675,3305,4178,3901,8495,5464,8241,7778,5415,2185,2383,2173,8105,4708,5757,2924,8673,8301,3130,7191,2761,3273,2289,6071,3577,3748,2508,5092,8347,6402,7420,3031,8180,2346,3046,2433,2702,4234,2379,2030,8353,5267,7995,8404,4419,6001,6301,7902,5383,5739,5612,6138,3027,5755,2459,7933,8055,8359,4374,4784,3032,2714,2466,4008,8809,2476,6313,4393,3219,2967,4970,7997,7694,5696,4930,3404,7384,5702,5717,6085,5316,2950,8714,6609,3652,4783,3060,8077,8548,5052,2007,7628,8598,7908,2623,3330,7883,5203,5087,4760,2425,2355,8510,6400,7056,3676,6191,2282,4801,4612,2461,5603,5490,3302,8944,8443,7648,7114,2707,5608,6345,3555,3737,7870,2356,2394,4966,4723,5616,7130,4401,3819,5152,4327,6080,2189,3656,5887,5743,5622,4788,3618,2342,7274,8755,4455,8247,4344,7705,3611,8859,4672,7116,7093,3370,7986,8023,4325,3360,2351,5836,2611,2324,5407,4527,2274,2859,4663,2347,7502,7425,5780,5535,4113,7700,4857,4986,4726,3399,7414,2445,2968,5325,4085,6989,7937,4507,7568,2364,4600,8419,2990,7786,7667,8733,7473,6767,8227,4177,5109,7905,2588,8283,3195,2510,3522,3438,7714,6982,3034,5495,8657,3794,7621,5761,8833,5594,2502,8776,4699,4110,3441,6197,2314,4394,2234,2103,5037,8557,7960,7676,4702,5951,6203,8108,5565,5027,4579,2918,3751,8374,5563,2405,7326,5453,3170,4941,4278,3098,7050,3837,2653,4403,3475,5274,4414,3877,4714,5690,6317,2413,4841,8712,3952,7688,5948,6135,3721,4635,5099,2442,7682,7748,3688,3626,5357,7639,2438,5644,8778,8882,6022,2257,2039,3019,4907,7948,4964,4798,8852,2793,7328,6350,3580,3452,3939,2684,4369,4257,5237,7723,8917,7253,3340,2484,3924,5562,8399,2680,4445,7517,7138,5510,4169,7474,7941,5614,4032,8742,7584,6240,6014,3464,8409,6492,3772,6077,6333,8284,5340,4531,8798,4998,8867,3570,8299,6900,4555,8839,3405,6272,6035,2643,7363,4820,2518,8025,7972,3444,2058,2094,8179,4595,8099,8248,2901,3588,3845,5623,4249,2894,4265,3839,2570,7318,6414,8028,7031,7210,5011,2171,7092,8087,4882,8341,5571,4775,7958,7049,4044,3514,6583,7098,8813,4823,3770,3769,6266,5663,5219,8340,2128,4080,2006,6298,5979,6341,4468,6083,7374,3359,2763,8731,3059,3323,6987,7548,2027,7307,6882,5336,8656,2184,3450,6709,2005,3224,8638,8485,7658,6042,5800,2038,7729,3687,5104,6143,3343,8453,2386,2939,7718,7394,5275,8459,6423,7286,6840,4825,7655,5180,8421,2543,4547,4400,7100,8651,3392,2515,2553,4334,7301,7944,4938,4188,3415,2701,3254,4478,7461,8697,4780,5369,8129,7503,7272,4840,7136,4211,8684,8372,5359,7297,2745,3524,5400,4871,3904,8642,3171,2449,3228,2192,4902,5266,2816,4674,8123,3755,3867,8543,8872,2048,7112,7403,6718,8009,4318,5503,3482,7016,5595,8473,8128,7800,8254,2362,6353,5670,3527,3504,7685,3378,2271,3080,5358,5810,2897,2715,4525,4237,5454,4651,8211,6095,8728,8786,7589,2848,6455,6145,3048,8738,4277,5888,4417,3283,7223,3594,2636,3180,2361,4906,8295,8369,2297,4533,8514,6578,5754,8694,2501,4433,7263,3906,2985,5476,7991,7733,2153,7087,2003,5354,7357,8754,3348,2794,2886,5238,5724,8597,5848,6753,8428,7431,2376,5324,8148,7163,5596,3184,5913,3172,3966,8650,4229,3297,5039,7267,6287,7520,5096,8182,6283,2105,4498,3138,7744,4120,7918,2272,4224,6235,4553,8042,8878,7094,6556,2475,5380,3387,5787,4748,4315,5075,8683,7361,7558,3407,6879,4258,3062,2381,5551,5140,8356,5449,4774,8107,3440,5308,3715,7955,2360,2717,7343,8927,5876,7265,8486,5184,2993,3331,4671,8608,2439,8157,5410,4432,6439,8216,4290,5680,8815,4811,5541,5302,5278,2341,2857,7011,4529,3043,6953,2332,4168,2424,5837,4759,6213,4710,3166,7776,5692,5076,3636,3996,5870,5697,2674,4654,3192,2786,8439,2182,5361,7717,2281,5273,2911,2470,3042,6470,4954,7275,3225,6469,7115,5629,7894,3850,2776,7803,7511,6336,2180,6497,6405,3064,3640,5890,6990,5438,3554,6117,5360,7452,7419,8579,7244,3501,4266,6866,3298,6721,2534,2275,6993,5985,4352,2154,8255,5651,2114,3339,6365,4827,2952,5597,5513,6288,7792,2779,3953,6319,5337,8800,3306,7395,4150,7271,5094,3500,4744,6498,3210,7217,7124,7537,4819,5365,5620,7158,2571,2519,8916,4165,3620,8394,6850,4895,8164,5751,4461,2463,3993,5546,4118,4275,6413,5536,6011,5198,3366,3386,3975,5973,4942,6337,7743,7962,5909,2049,3895,6488,7681,5590,8811,8664,5139,7825,4640,5054,7006,8454,2012,5607,6108,3142,7500,8929,6384,8748,5679,5659,5900,8522,2227,3884,5240,4235,8665,3526,5621,7857,6783,8516,5142,8698,2412,8567,8508,5298,5040,7608,3858,2927,3681,3324,3907,4657,3335,4166,2722,5501,6422,8090,2077,8250,2973,6861,5226,4782,4881,8767,6252,5885,8303,7485,6075,5819,4923,4641,4121,7466,8891,4321,4629,7684,4599,4107,2695,7845,2949,4100,5414,2167,4153,8546,3899,7251,2265,4739,3629,3711,7300,4860,3095,8590,6443,2092,3445,2546,7178,3919,3057,5032,4225,3990,8689,2116,2808,2176,6123,2301,6007,2451,3968,3020,6794,2614,6421,4604,4631,2948,8822,6018,7045,2599,2778,2634,3085,5352,5789,5343,3091,2858,8245,2842,8491,4292,8519,3590,4977,7209,5990,7276,3418,4946,7491,8376,5625,4102,8261,7451,4542,5917,5393,7653,2217,8468,2783,4967,3110,3115,7930,4281,5766,5431,8293,3948,5422,4190,5084,4017,5592,3123,7999,5249,8761,5447,5785,7764,8920,2101,4830,8586,2156,6032,2569,6227,2066,4308,4186,8455,2026,6281,8559,4086,5570,4813,2350,3497,5245,7957,2369,8903,2441,2016,2203,5382,5154,6495,3094,6008,3995,5271,6293,2748,4793,2988,4505,4981,7891,7851,3379,5305,3959,4634,7051,5190,7247,8845,4598,8515,5520,8876,7665,7061,8663,2747,2627,3663,7935,3041,8521,4054,8231,5722,4502,2559,6430,4053,3045,4431,2827,3665,6829,8946,5705,4884,4802,2472,8874,5902,3530,7767,4012,3974,7475,7245,2456,2549,6849,4007,7195,3861,2925,2286,7704,7198,3778,8317,6919,2694,4196,2836,2464,7618,5647,5417,8828,2890,3277,8302,7538,4511,3669,3274,8327,3272,2945,8083,4752,6830,4094,5019,8935,7090,5297,8047,7334,3376,5815,6148,4499,8703,6459,2396,4418,4067,6611,3624,2696,6196,3938,7677,5196,7712,4354,8214,7235,8745,6012,3393,7075,4691,5105,5013,4539,8750,4963,3533,2820,6923,8479,7310,4027,6744,2474,6332,3008,4367,5897,8517,7107,2397,3543,3915,4206,4396,4035,3610,8918,4261,6983,4040,5778,3003,2188,7155,3499,4372,2492,2757,5242,4191,3036,8490,5119,2388,7758,8400,3854,6079,6153,3282,4366,4324,2837,8116,6015,3231,5605,3684,7282,4839,5487,4689,4004,5812,4934,2551,6481,8655,7971,6210,8253,6280,6960,7096,3177,2934,5402,3267,4570,6606,3403,8304,2818,2100,4297,8791,5007,5542,7625,8285,2480,6686,4850,4038,2181,8448,4706,2834,3735,2758,7881,8503,2417,3584,2689,6152,5078,3160,5989,5401,5814,4198,4685,3194,2609,5745,8172,2365,4057,6120,3256,2024,6441,2740,4175,6052,8110,6428,2759,5728,2046,2178,5518,8505,8667,7208,5537,2540,5703,4847,5074,5016,5456,3159,4916,5584,2469,8551,4059,3661,2056,8646,2550,7980,2505,6150,7524,3309,2789,3293,2382,3956,3698,4376,5311,5648,6026,5674,8389,5672,3338,8081,3201,6473,3962,2548,6417,8583,7862,8668,6361,7067,6418,2004,3878,8338,5125,7393,5015,5366,4561,3395,5376,4940,7406,8146,5386,3241,5782,3650,7242,8298,8016,5879,3622,8206,6507,6401,8930,6309,7609,4587,2131,6605,3081,3133,7698,3112,7291,8308,3933,7874,5147,7021,2677,3742,3608,7097,2174,4975,3510,7596,2411,5517,2460,8142,7837,4939,3723,4259,2529,4448,8320,6241,3230,2754,2803,5549,5412,3595,2304,5329,3545,5144,5935,5944,6375,3292,3866,8343,7487,8856,7664,8186,8709,4737,3365,7417,3275,6425,5451,2268,7424,4925,6503,6768,5124,6218,6233,8131,7033,2028,2978,4932,4409,2020,4476,7295,3289,3773,3453,3814,6127,4447,7817,2719,7835,3351,2483,3263,2992,2729,4202,5926,4099,4232,8777,2641,4677,5971,4096,6429,7127,4122,8627,8106,6827,3541,7583,6223,2091,4214,7202,7741,4578,2866,5790,5321,6041,8931,4803,7956,5005,8696,7325,4569,3345,7280,4486,3639,4593,5599,3540,3799,8141,4483,6893,3204,4048,4729,8726,3187,2107,3491,5060,2218,8681,2851,5279,5967,3963,2563,3462,5632,8851,5199,7319,3701,4314,3023,8226,5059,2377,8370,2998,4776,3429,2914,8256,2187,8775,8277,7048,4494,4883,2999,7909,3472,8273,5883,4644,5506,4371,3668,5371,4821,4750,3569,2951,7489,8901,6398,5260,5630,3191,2479,5355,2071,8018,4263,5062,7078,6499,8574,3000,2490,3079,2654,6044,3905,2034,6221,3851,3857,2231,3704,4740,7215,5166,3693,4475,4319,5582,3250,7287,8512,4666,3969,7812,2879,7507,8242,3181,7240,5713,2547,3824,2140,3396,6246,4093,6367,4756,6016,2481,6212,4837,5120,3870,7156,8066,7183,7693,2223,7060,7736,4869,8150,8827,3276,4172,2011,3942,6087,2317,6296,6144,3344,4415,6166,7761,5502,2881,4282,6082,7725,3955,7175,3381,8647,5669,4134,8536,3136,7657,7131,7118,3465,8690,3038,7261,5300,6881,4694,8174,8509,6617,5544,4646,5982,8362,7575,2273,2536,5685,8281,7616,5561,6195,7656,7372,5911,8096,8633,6058,8862,6486,6063,3113,3265,3203,3812,6009,3268,8350,2219,3294,2487,6344,7903,4251,6994,5655,8425,3284,8239,2868,2590,3409,4541,3847,6543,4392,5218,4962,6380,6817,3848,6374,2573,5167,2078,8921,5304,2721,5334,8534,4364,7470,4670,4047,5153,2815,7278,2447,8429,2888,7872,5557,7709,8893,5914,7974,4909,8913,7365,8734,2982,2104,7204,8781,3185,5489,3363,6324,4370,8600,7400,3612,8472,2267,2790,2319,8880,3009,4647,4844,3651,8044,8270,7254,4016,2947,5488,3443,7387,5946,7678,3439,3411,4516,2503,6381,8614,6720,5889,4479,2539,4056,5695,4551,2910,7742,5987,5420,7915,4500,2055,3725,4753,5610,8163,8102,8114,6871,7547,3921,5720,8020,4806,3480,8236,2625,4667,2093,4596,3063,5468,2577,4305,5349,8470,5462,5999,2863,5781,5986,7569,4943,5363,3332,2902,7715,7493,6424,5526,3872,5486,6051,2498,6865,3052,7794,8354,5653,2841,2252,7205,8540,8037,4387,6818,5950,5756,3967,2212,7586,4518,7501,6824,8910,6640,5085,5813,3490,6796,6889,6988,6188,2063,8626,2132,6546,6189,2616,8154,2022,7855,5071,5341,6777,4763,4070,4548,2191,8679,2612,6194,3014,5174,7128,7542,8695,5372,8313,4904,5553,4167,4046,7887,2395,2524,7152,3792,4274,3239,8234,4588,3487,3994,7886,7597,2214,8203,2309,2755,8461,5135,7335,2826,7340,5657,7730,3435,3572,3471,6045,3021,8068,5231,2906,6843,7499,7669,2991,7610,8568,7987,4735,6121,5069,2453,7197,2996,2391,8396,4151,6992,3347,6209,5617,6184,4626,2168,5804,6182,7671,7076,6407,4594,3642,5791,2270,5193,3605,7341,8469,5545,6176,4713,3542,5330,8089,2323,3266,5017,5581,2825,2703,2330,2138,7645,5742,6291,7555,4582,7246,8873,7471,2175,7994,7750,2956,4462,4205,2374,5378,3935,3193,5978,5811,3454,3800,6804,7572,6017,2940,7432,6177,8168,5701,3648,5750,4926,2419,2944,4993,4983,5455,7063,4375,3843,4026,4451,3759,5356,8160,6799,8720,7544,5127,4523,6463,3746,3427,3971,7992,2291,3213,2047,6260,6239,4842,8039,6104,5943,6385,7726,2987,5201,2235,3279,5066,7734,3469,5408,2358,2601,2204,3485,3604,5874,4197,8384,7268,2486,2544,5255,6230,8803,6771,3558,2127,2679,8900,6878,4410,5591,5080,3291,8497,7598,3314,2044,4867,3483,8783,3262,3001,7896,7654,2206,4786,7258,2129,2296,4747,3544,5009,8311,4320,7194,8345,3320,2031,3697,7964,8416,3285,3412,8950,3168,2822,5880,5283,3357,6131,6996,2581,2774,8492,8463,6318,2678,4921,6046,2706,3069,2632,8643,6597,8363,8680,8209,6300,6251,6697,4194,8202,2746,8233,3253,2244,3827,3101,5423,8774,3358,2853,4029,4885,4136,3270,4838,2800,8718,2642,8403,3823,8093,4174,4574,2061,3055,8550,2448,4772,3983,2163,8063,2414,2393,8575,7624,8435,6190,3384,3150,2415,2979,8346,7998,3312,4950,8549,3743,6847,3119,8316,7739,2784,5225,7465,8289,8398,3929,2238,5797,2158,7132,3707,6326,7856,2687,2509,8457,4127,2751,4317,4111,6841,7312,7133,2060,3426,2019,8501,3763,5029,6454,6415,5786,3367,5627,8079,5090,6084,3096,6057,8552,8555,7913,3673,2963,3468,2144,3264,3548,2021,3155,8219,2970,7379,5217,4514,5962,3664,2313,2186,8038,8238,7472,8342,8189,7785,8379,2241,3849,2913,8210,8171,5008,2136,3406,8405,2142,2316,5846,8895,7150,8715,7228,2359,5523,4956,4116,8666,8329,5763,3513,7468,5254,5034,2775,6247,3493,4090,7751,4386,5158,2125,5579,3619,6399,4115,6641,6911,8482,3234,8802,6158,8717,8451,8259,5170,8312,7477,5484,7207,5558,3562,7695,7822,8103,4558,5841,4709,6320,6426,5063,4982,8746,8272,2760,4236,3010,6899,7106,7382,3025,5765,2750,4346,6024,3846,4800,3614,2920,3561,6261,7943,6204,8630,7027,7807,8658,5424,4192,3002,2870,4388,2773,6306,7029,7169,3657,8940,8749,8644,4999,2799,7443,7738,3176,7054,5452,6133,4088,7650,3337,5566,8523,8288,8388,4299,6193,2008,4822,3432,8262,3505,4223,4397,8784,8447,8554,5002,7892,7269,7644,4980,8225,4540,7531,2648,7381,8507,6129,3389,4992,2883,3295,2507,7806,2454,5899,2861,5609,5303,6128,7843,8853,2921,3070,3516,6109,4011,8328,2504,3864,5521,5877,4586,2308,8797,7838,6065,2407,3408,7595,3232,3702,2279,3520,6460,2431,4495,5624,2936,3105,6107,7973,3633,5077,5741,5232,2891,7445,4652,4076,7117,5143,4333,7882,4399,2043,8230,4472,3153,3131,4658,3730,8373,5191,2165,7324,7052,3834,5940,3496,5694,8531,5387,6330,4033,8535,4231,6472,4378,4377,6489,7631,2371,5996,7391,8926,4065,5327,3216,8127,3099,7965,3104,7121,6025,2416,6888,5181,7893,7889,4276,2251,5220,4183,3325,2916,2473,3653,8098,3592,5867,2961,4770,4914,7961,5314,5413,3977,3073,2606,2337,4072,8246,2650,8147,4141,4360,5411,2095,2457,7527,6737,4767,7089,4988,4395,3413,5163,4106,2428,8130,3336,6490,4459,2514,3287,4271,8493,4031,2805,7234,2692,8899,5106,2984,2151,4638,8290,5030,4931,3164,3252,4722,3912,3677,4834,5001,4995,2242,7988,4826,8834,2708,8223,4863,5252,5707,8069,7674,5664,2172,2436,2895,6244,6303,7123,2523,2846,7702,2333,7949,5604,5150,4606,8547,4434,3488,7402,4356,2400,8276,8500,4630,5733,7189,7358,2277,5264,7494,3459,8324,6064,7068,7791,3782,8355,4785,3107,3703,3211,6186,4488,5613,4951,3198,4575,2331,7375,4915,8637,8687,2054,2209,8537,2410,2194,3121,3221,4745,8392,4411,8139,2869,5555,2150,2216,5172,3788,5236,4343,3879,7623,6156,5429,8905,3613,5934,6308,3058,4688,5732,2730,7171,7293,6920,5493,4307,7753,3916,6229,2357,2787,4117,5121,3680,8053,8609,3627,6595,3126,2170,4879,7784,8866,6349,3756,3798,2975,3410,2062,7264,8412,7188,7149,3154,4618,8366,8762,5396,6013,2437,3568,5809,8045,7294,8711,2123,8888,6482,3634,8941,3660,5661,3574,6307,3930,6359,3196,3591,6231,5678,2673,4142,4467,6388,2847,5776,4009,2565,8716,3777,7940,8185,2986,2596,8707,4639,3862,7635,5769,3606,2335,2541,8064,6793,7565,7766,4559,5554,8145,5677,2232,7396,8588,5353,6232,2688,3361,3865,8919,6132,8393,6797,7303,8632,4105,8115,4725,2010,7724,8062,8381,8424,7989,4655,2564,6358,3242,5061,5333,5006,2585,7147,6134,5942,3896,5286,8857,2575,8906,2130,3317,4291,2527,5859,4039,6449,6072,4404,7934,5395,8474,2538,2603,2269,7039,3355,4778,6621,6299,2792,3679,4937,8296,2137,2583,5159,3016,8759,6968,2840,8287,5798,8275,5207,4073,7104,4549,2321,8430,8192,3881,4473,3183,7141,8560,7146,6347,2528,8092,2205,3394,3979,5367,6356,2392,3466,8052,3536,4922,7593,4927,5795,7582,5991,3909,8691,2637,7600,6444,2764,3451,7042,2630,3708,3117,8652,5175,7281,5779,2850,4704,8513,2261,2912,3495,7405,4817,8326,8005,5682,6346,8561,2081,3666,8596,6868,3156,3209,3785,3083,5397,5281,5441,3286,2629,2025,8587,8423,7976,4109,7371,6434,5939,2477,4991,8570,5307,3749,8043,6295,6154,5963,7952,4365,2090,2152,4661,7292,7102,7148,4707,7166,6757,7184,3804,5878,3789,7647,5933,4180,7192,2953,6795,3587,5406,4087,8796,5801,2699,6756,4653,4348,8478,5197,5459,3747,7713,8194,8386,5693,3860,8080,6754,4789,4972,4695,4444,7219,7181,4583,6412,4898,7296,7782,4268,8747,7427,4497,5747,2835,3731,8434,3377,3986,7129,2741,6382,5806,4010,5241,3308,5057,8865,6027,7867,4424,7613,6020,4041,3833,7574,7799,3752,4965,7260,7434,5738,7002,3559,3531,2520,5439,2562,4607,3005,3871,8699,2712,7323,5615,5326,6924,2749,4052,3811,2671,4872,5921,3662,4098,5976,4024,6377,7699,8956,5910,2877,8938,5227,5443,4220,6168,5849,7041,2579,7752,4650,4544,8553,3122,3599,3754,7533,5726,8462,4262,2222,7570,7025,2670,7134,8000,3603,5435,2311,8167,3421,3322,2051,8170,6577,7519,8173,5515,4045,8620,3385,3167,3362,7153,8321,3129,3458,7787,8928,8886,7305,8805,8065,6099,6199,8330,6440,8837,7535,4049,2037,4771,3229,2796,7922,6387,4143,8282,7440,2298,4477,8397,3519,3529,3637,3675,4089,4673,7023,8010,7001,2499,7877,3720,7607,2075,4807,3245,7347,6870,8564,6157,5117,4804,4228,6708,4901,3074,6731,3033,2584,5299,5458,6468,8790,7771,8383,5671,2943,7945,2824,5364,4777,7581,5767,2085,7047,8243,5992,4145,7848,5941,2635,6021,7670,4240,2626,7649,3511,4526,5930,5370,5444,8161,8898,3762,2506,5469,3364,6271,7082,2111,2744,3528,2814,2363,5020,4181,3118,6961,2201,8623,8722,5823,7024,3269,5882,3583,4741,8124,5709,8382,2959,4692,2496,3102,4851,6376,3678,5093,7359,2340,4805,5392,4304,3220,6005,2542,3341,7996,4254,5292,5151,8542,2017,3169,7277,5221,4221,6224,3556,5268,4602,5465,2578,8156,5891,8511,4340,3787,7824,5425,4508,4355,7947,8576,3484,2115,3615,4773,8391,2813,2322,6264,3549,4021,6031,2582,8413,5524,8138,8843,8951,8314,6242,8806,2468,3449,7690,5478,4412,3460,2983,4976,7686,8807,3810,3750,5504,8133,4302,4030,2199,4435,3581,2928,6685,2086,5718,8075,8589,2862,4718,8444,7854,4637,3515,7005,4550,3093,3072,2087,2228,4974,4678,7810,7592,5912,8056,7526,8380,8858,3547,5421,6215,7283,6438,2882,8187,5509,3980,4787,3007,6448,8041,3108,8476,4162,2723,6450,3463,3694,2752,3050,7222,2734,4289,8072,4781,5538,2226,2491,2742,5374,7481,5850,2306,7055,4584,2002,2042,5317,3512,7809,7433,3674,8458,5012,4818,7550,6383,2118,5461,6328,6081,5282,6294,7165,4006,7942,7256,6837,2213,6496,2102,5204,2018,8737,3958,7985,6049,7250,8323,8676,2683,8357,2408,7137,8335,7187,3206,7617,6067,4536,4350,5073,2147,7823,8706,5737,6758,2658,8218,8849,3165,8213,8274,5530,4633,3944,8844,5295,4953,7266,3051,6431,6340,7311,7122,6066,4615,8577,5772,5589,5222,5312,3149,7759,7182,7912,7144,4519,4460,4619,5270,2082,8573,8048,8848,6608,7080,8306,8943,4734,5768,4218,5628,2482,6159,5606,4701,2157,7119,2662,5319,7478,3257,5014,6343,4563,2735,8894,2029,7757,3299,3280,7415,8402,8619,7662,5691,5243,5205,3212,7321,3071,8532,6484,6876,5389,8634,7139,4060,4984,6504,3146,2782,6256,3658,8414,7259,4727,3607,3732,7740,5409,4969,8088,3893,8385,3249,8836,2143,8799,3925,8031,2736,6270,4997,7525,7450,2045,2263,8520,5844,5805,2098,6452,4179,6711,6338,3802,3978,8621,2517,3623,5277,4700,4510,4061,2781,5165,4632,3682,5725,8176,4874,4610,8771,2287,4335,5908,8352,8488,3375,8592,3525,5957,4171,7380,5626,5348,2139,4509,8616,2198,5522,5548,8036,5202,6202,8949,5472,6141,2676,8925,4092,5070,7850,3988,3327,3700,7804,3182,8190,3374,6780,6248,3806,8113,2780,2743,2035,7185,3852,2933,2009,5683,2938,2452,2660,3024,7858,2838,2083,6477,7249,2385,5927,3189,3236,2533,8280,6059,8544,2873,8001,8224,8436,5977,2493,3589,6458,2366,2593,2141,4705,3028,3175,2239,2389,6282,2937,2195,2831,6534,4022,3261,6329,5259,8571,8659,7046,8602,5215,4889,8467,3686,4130,6722,3683,6446,7816,2923,3786,8084,4408,8948,2613,6342,8263,4833,3065,3717,2656,3420,2097,6946,5748,5550,4696,7849,6500,3456,8318,6962,3012,6355,2604,4668,6921,4919,7899,8049,5764,5239,5185,6467,7483,2668,7062,7968,5344,8155,4568,2631,6304,8723,2765,6550,8705,2597,7345,8835,7818,6778,2669,6522,7659,7668,3667,3125,6323,5473,5583,6331,8101,6237,2080,4690,3868,2605,8387,2811,6286,2905,7145,6378,8215,5988,3926,7229,5265,6036,4625,3243,5777,3903,2450,5656,2258,6310,6506,7907,6901,3473,5803,3455,5708,5436,3157,6314,4170,6952,3999,2121,8411,6207,2262,8612,5132,4474,2980,4001,3736,4066,3353,8578,8440,3973,8480,5587,4091,4887,5467,8015,7981,5981,2874,3313,3728,2067,3006,4385,3991,7683,7034,3793,8378,3902,3311,3134,2455,6180,3208,2243,6006,7731,4215,4799,4996,5111,8058,2554,6476,7557,4311,5894,5136,3796,7622,4300,2704,5466,5118,5847,7074,2300,7553,2427,8481,2770,8817,4577,3726,8074,5699,3981,7696,6892,8772,6074,7084,5284,4769,5058,2621,3600,7798,6437,3940,2073,2290,5556,5160,8599,6464,2560,5932,2471,3278,8244,5759,5483,3841,4248,2989,7506,7004,3251,7793,3998,6124,6366,8601,4164,6000,7920,4957,5711,6410,6397,5676,5918,8183,3557,8558,8178,4733,7844,4256,7606,5309,2844,7455,7852,7549,7284,7479,7009,5182,5716,6169,2254,7691,6390,7897,4353,6445,2485,4284,7190,8358,4189,8506,5342,7233,3585,6809,2070,4515,4273,3771,8002,4095,3641,7170,6478,8641,4730,7495,3908,8032,3863,3923,7174,5970,3920,5975,4156,4676,8319,5531,8118,3601,4534,3566,4758,2576,2724,4422,4580,2260,8868,2600,3237,8217,2069,3970,8086,6225,5831,4987,7612,7518,8162,6420,2430,8518,7248,4384,8945,3015,8763,8257,7983,4280,6389,3521,7777,7522,3984,7869,2922,3103,8701,3179,3333,7953,6764,6267,8050,7040,4897,6991,5907); #(1, 2000)

# Download the listed topics more than once, boolean
# Use this to grab topics that have had new posts since your last rip
# (which you should probably specifically identify in @get_topics, because it's not magic)
my $repeat_thread  = 1;
# optionally add a delay (in microseconds) between requests to
# prevent problems if they throttle you (download only)
my $delay          = 4_000_000;
# verbose messages during run?
my $verbose        = 1;
# Use login (should work)
my $username = ''; # 'Web-Admin'
my $password = ''; #'A39FJ9,0'
# Leave empty
my $authorz = '';

# The Actual program
#####################
my $root_url = "https://$domain/$api_path";

if ($username and not @ARGV) {
    $ua->get("https://$domain");
    my ($sid, $sid_backup);
    my $cookies = $ua->cookie_jar->all;
    for (@$cookies) {
        if ($_->name =~ /_sid^/) {
            $sid = $_->value;
        }
        if ($_->name eq 'PHPSESSID') {
            $sid_backup = $_->value;
        }
    }
    $sid ||= $sid_backup;
    print "Logging in with user: $username, session_id: $sid\n";
    # Form POST (application/x-www-form-urlencoded)
    my $res = $ua->post("https://$domain/ucp.php?mode=login&import_login=1" => form => {
        username => $username,
        password => $password,
        login    => 'Login',
        redirect => 'viewtopic.php',
        sid      => $sid,
    })->res;
    if ($res->code eq '200') {
        print "Login failed\n"; # should have redirected
        print "Proceeding anyway...\n";
    }
    else {
        print "Login successful\n";
    }
}



print @ARGV ? "Reading from " . scalar @ARGV . " files"
    : "Gathering data from $root_url\n";

my $dbh = get_db($db_file);
my %seen_users = map {$_->[0] => 1} @{ $dbh->selectall_arrayref("SELECT username FROM users") };
my %seen_threads = map {$_->[0] => 1}
    @{ $dbh->selectall_arrayref("SELECT tid FROM threads UNION SELECT tid FROM bogusthreads UNION SELECT tid FROM unauthorized") }
    unless $repeat_thread;

# The main loop
if (@ARGV) {
    for my $filename (@ARGV) {
        extract_posts( Mojo::DOM->new( slurp $filename ) );
    }
} else {
    my @topic_list = scalar(@get_topics) ? @get_topics : ($start_topic .. $end_topic );
    for my $topic (@topic_list) {
        download_thread( $topic ) unless $seen_threads{$topic};
    }
}

sub cache_get {
    my ($url) = @_;

    my $md5 = md5_hex($url);
    my $cache_f = "$cache_d/$md5";

    if (-e $cache_f) {
        print " - $md5 - ";
        open(my $fh, '<', $cache_f) or die "Can't open $cache_f: $!";
        my $content = do { local $/; <$fh> };
        close($fh);
        return Mojo::DOM->new($content);
    } 
}

sub cache_put {
    my ($filename, $mojo_object) = @_;
    my $fh;

    my $md5 = md5_hex($filename);
    my $cache_file = "$cache_d/$md5";

    my $content = defined $mojo_object ? $mojo_object->result->body : '';
    unless (open($fh, '>', $cache_file)) {
        die "Could not open file '$cache_file' for writing: $!";
    }

    print $fh $content;
    close($fh);
}

sub cget {
    my ($url) = @_;

    my $content = cache_get($url);
    if ($content) {
        return $content;
    } else {
        my $ua = Mojo::UserAgent->new;
        my $tx = $ua->get($url);

        if (my $res = $tx->success) {
            cache_put($url, $res);
            return Mojo::DOM->new($content);
        } else {
            my ($err, $code) = $tx->error;
            die "Failed to fetch content for $url: $err (HTTP status code: $code)";
        }
    }
}

my $now_time = 0;
my $ltime = 0;

sub do_sleep {
    my ($seconds, $microseconds) = gettimeofday();
    $now_time = ($seconds * 1_000_000) + $microseconds;

    $ltime = $ltime || 0;
    my $tosleep = max(0, ($ltime + $delay) - $now_time);
    #print(" :: $tosleep ::");
    usleep $tosleep;

    $ltime = $now_time;
}

sub download_thread {
    my ($topic, $start) = @_;
    $start //= 0;

    print "looking for thread t=$topic&start=$start";

    my $schema = "$root_url :: $topic :: $start";
    my $dom = cache_get($schema);

    $dbh->do('DELETE from posts where topic = ?', undef, $topic);
    if ($dbh->err) { die "Unable to delete $topic: $dbh-err : $dbh->errstr \n"; }

    if(! $dom) {
      do_sleep();
      my $mojo_obj = $ua->get($root_url, { 'Accept' => 'text/html'}, 'form' => {
          t => $topic,
          start => $start
      });
      cache_put($schema, $mojo_obj);

      my $res = $mojo_obj->res;

      unless ($res->is_success) {
          if ($res->code eq '404') {
              $dbh->do("INSERT OR IGNORE INTO bogusthreads VALUES (?)", undef, $topic);
              say " - 404, bogus topic";
              return undef;
          }
          else {
              confess "HTTP error: " . $res->code . ' ' . $res->message
               . ( $start ? " -- died in the middle of t=$topic\&$start=$start" : '');
          }
      }
      print " - downloaded - ";
      $dom = $res->dom();
    } else {
      # print " - cached - ";
    }

    if ($dom->at('.login-body')) {
      $dbh->do("INSERT OR IGNORE INTO unauthorized VALUES (?)", undef, $topic);
      say "UNAUTHORIZED THREAD";
      return undef;
    }

    my $savecount = extract_posts( $dom );
    if ($savecount == -1) {
      return;
    }
    print "$savecount saved\n";

    unless ( $start > 0 ) {
      # get thread size
      $dom->find('.pagination')->last->text =~ /(\d+) post/;
      my $postcount = $1;

      # recurse if we need more pages
      $start += $posts_per_page;
      while ( $start < $postcount ) {
          download_thread( $topic, $start );
          $start += $posts_per_page;
      }
    }
}

sub extract_posts {
    my $dom = shift;

    # Get topic information, even if we already have it
    my $title = $dom->find('.topic-title a');
    if(! $title->[0]) {
      return -1;
    }
    $title = $title->[0]->text();
    my $topic_id = $dom->find('link[rel="alternate"][title^="Feed - Topic -"]')->first;
    if (defined $topic_id) {
        $topic_id = $topic_id->attr('href');
        $topic_id =~ s|^.*?/topic/(\d+).*$|$1|s; 
    } else {
        $topic_id = $dom->at('.action-bar input')->attr('value');
    }
    my $forumid = $dom->find('#nav-breadcrumbs .crumb:last-child')->last->attr('data-forum-id');
    say $title;

    $dbh->do("INSERT OR REPLACE INTO threads (tid, forum_id, topic) VALUES (?, ?, ?)", undef,
        $topic_id, $forumid, $title);

    my $savecount = 0;
    $dom->find('.postrow')->each( sub {
        my $post = shift;
        my $pid = substr( $post->attr('id'), 2);
        my $count   = substr( $post->at('.author a span')->text, 1) - 1;
        my $datestr = $post->at('.timespan')->attr('title');
        my @datestrings = split / - /, $datestr;
        my $dater = "$datestrings[1] $datestrings[0]";
        my $date = ParseDateString($dater);
        my $timestamp = UnixDate($date, '%s');
        my $author = $post->at('.avatar-username-inner .thread-user-name a');
        if (defined $author && $author ne '') { 
          $authorz = $author->text(); $author = $authorz; 
        } else { 
          $author = $authorz; 
        }

        # We have post titles again now, and it might be easier than before.
        my $posttitle = $post->at('.post-title');
        if (defined $posttitle && $posttitle ne '') { 
          $posttitle = $posttitle->text(); 
        }

        # were we edited?
        my $edit_count = -1;
        my ($last_editor, $edit_time);

        # The Great AJAX Adventure
        if (my $notice = $post->at('.notice') ) {
          my $eres = cget("https://$domain/app.php/history/getposthistory?postid=$pid")->res;
          my $adom = $eres->dom();
          if ($adom->at("#historyline_$pid")) {
            $last_editor = $adom->at('a')->text;
            my $edittakeone = $adom->at("div + *")->text;
            my @editstrings = split / on /, $edittakeone;
            @editstrings = split / - /, $editstrings[1];
            my $editor = "$editstrings[1] $editstrings[0]";
            my $edate = ParseDateString($editor);
            $edit_time = UnixDate($edate, '%s');
            $adom->find("div")->each( sub {
              $edit_count++;
            });

          }
        # End of the Great AJAX Adventure
        }

        my $attach_node = $post->at('.attachbox');
        my $content_node = $post->at('.content');
        my $content_has_collage = $content_node->at('.collage');

        my $collage_node = '';

        if(!$content_has_collage) {
          $collage_node = $post->at('.collage');
          $collage_node = '<div class=collage>' . ($collage_node ? $collage_node->content : '') . '</div>';
        }

        my $content = '<div class=content>' . ($content_node ? $content_node->content : '') . $collage_node . '</div>' .
                      '<div class=attachbox>' . ($attach_node ? $attach_node->content : '') . '</div>';

        my $sig = $post->at('.signature');
        my $signature = $sig ? $post->at('.signature')->content : undef;
#say "PID: $pid";
#say "TOPICID: $topic_id";
#say "COUNT: $count";
#say "AUTHOR: $author";
#say "TIMESTAMP: $timestamp";
#say "EDITCOUNT: $edit_count";
#say "LASTEDITOR: $last_editor";
#say "EDITTIME: $edit_time";
#say "POSTTITLE: $posttitle";
#say "COOONTEEEEENT: $content";
#say "SIIIGNATURE: $signature";
        $dbh->do('INSERT OR IGNORE INTO posts (pid, topic, seq, author, utime, edit_count, edit_user, edit_time, post_title, content, signature)
            VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)', undef,
            $pid, $topic_id, $count, $author, $timestamp, $edit_count, $last_editor, $edit_time, $posttitle, $content, $signature
        );
        if ($dbh->err) { 
          die "Import failed: $dbh-err : $dbh->errstr \n"; 
        }
        ++$savecount;

        # If we haven't seen this user yet, add her to the DB
        unless ($seen_users{$author}) {
            my $join_date = UnixDate( ParseDateString( $post->at('.timespan')->text ), "%s" );
            # Tapatalk axed usergroup readings for some reason, so for now just skip this... 
            # keep track of your own staff.
            # my $rank = $post->at('dd.profile-rank')->text;
	          my $rank = '0';
            my $post_count = $post->at('.avatar-username-inner .user-statistics .nowrap > span')->text;
            $post_count =~ s/\D//g;
            $dbh->do("INSERT INTO users (username, join_date, post_count, rank) VALUES (?, ?, ?, ?)", undef,
                $author, $join_date, $post_count, $rank
            ) or print "Couldn't insert user $author";
            $seen_users{$author} = 1;
        }
    });

    return $savecount;
}

sub get_db {
    my $db_file = shift;
    my $db_exists = -e $db_file;
    unless ($db_exists) {
        unless (-e dirname $db_file) {
            die "parent directory of \$db_file '$db_file' does not exist, cannot create schema";
        }
        unless (-w dirname $db_file) {
            die "parent directory of \$db_file '$db_file' is not writable, cannot create schema";
        }
    }
    my $dbh = DBI->connect("dbi:SQLite:dbname=$db_file","","");
    unless ($db_exists) {
        # Build the DB schema
        $dbh->do(q/
        CREATE TABLE threads (
            tid INT PRIMARY KEY,
            forum_id INT NOT NULL,
            topic TEXT
        )/) or die $dbh->errstr;
        $dbh->do(q/
        CREATE TABLE posts (
            pid INT PRIMARY KEY,
            topic INT NOT NULL,
            seq INT NOT NULL,
            author TEXT NOT NULL,
            utime INTEGER NOT NULL,
            edit_count INT DEFAULT 0,
            edit_user TEXT,
            edit_time INT,
            post_title TEXT,
            content TEXT,
            signature TEXT
        )/) or die $dbh->errstr;
        $dbh->do(q/
        CREATE TABLE users (
            username TEXT PRIMARY KEY,
            join_date INT NOT NULL,
            post_count INT NOT NULL,
            rank TEXT
        )/) or die $dbh->errstr;

        $dbh->do(q/
        CREATE TABLE bogusthreads (
            tid INT PRIMARY KEY
        )/) or die $dbh->errstr;

        $dbh->do(q/
        CREATE TABLE unauthorized (
            tid INT PRIMARY KEY
        )/) or die $dbh->errstr;

        # Tapatalk calls anon users 'Guest', and we don't want to look for their info so as to avoid script dying in a fire lol
        $dbh->do(q/ INSERT INTO users VALUES ('Guest', 0, 0, 'undef') /);
    }
    return $dbh;
}

# One-liner to read in an entire file in UTF-8, because why add a File::Slurp dependency
sub slurp { local $/ = undef; my $fn = shift; open my $fh, '<:encoding(UTF-8)', $fn or die "Cannot read file $fn"; my $c = <$fh>; close $fh; return $c }
